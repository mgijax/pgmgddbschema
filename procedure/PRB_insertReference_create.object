#!/bin/sh
#
# History
#
# 08/25/2014	lec
#	- TR11654/stored procedures for postgres
#
cd `dirname $0` && . ./Configuration
cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

DROP FUNCTION PRB_insertReference(int,int);

CREATE OR REPLACE FUNCTION PRB_insertReference (
refKey int,
probeKey int
)
RETURNS VOID AS
\$\$

DECLARE
maxReferenceKey int;
userKey int;


BEGIN

/* Insert record into PRB_Reference if _Refs_key/_Probe_key pair does not already exist */
if (select count(*) from PRB_Reference where _Refs_key = refKey and _Probe_key = probeKey) > 0
then
	return;
end if;

select into maxReferenceKey max(_Reference_key) + 1 from PRB_Reference
;

select into userKey _User_key from MGI_User where login = current_user
;

insert into PRB_Reference
(_Reference_key, _Probe_key, _Refs_key, hasRmap, hasSequence, _CreatedBy_key, _ModifiedBy_key)
values (maxReferenceKey, probeKey, refKey, 0, 0, userKey, userKey)
;


END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION PRB_insertReference(int,int) TO public;

EOSQL
