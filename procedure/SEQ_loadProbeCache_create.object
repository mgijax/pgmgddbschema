#!/bin/sh

#
# History
#
# 01/12/2004
#	- JSAM
#

cd `dirname $0` && . ./Configuration

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

DROP FUNCTION SEQ_loadProbeCache(int);

CREATE OR REPLACE FUNCTION SEQ_loadProbeCache (
sequenceKey int
)
RETURNS VOID AS
\$\$

DECLARE
userKey int;


BEGIN

userKey := _User_key FROM MGI_User WHERE login = current_user;

DELETE FROM SEQ_Probe_Cache WHERE _Sequence_key = sequenceKey;

INSERT INTO SEQ_Probe_Cache
SELECT distinct s._Object_key, p._Object_key, ar._Refs_key, p.modification_date, userKey, userKey, current_date, current_date
FROM ACC_Accession s, ACC_Accession p, ACC_AccessionReference ar
WHERE s._MGIType_key = 19
AND s.accID = p.accID
AND s._LogicalDB_key = p._LogicalDB_key
AND p._MGIType_key = 3
AND p._Accession_key = ar._Accession_key
AND s._Object_key = sequenceKey
AND NOT EXISTS (SELECT 1 FROM PRB_Notes pn
	WHERE p._Object_key = pn._Probe_key
	AND pn.note like 'The source of the material used to create this cDNA probe was different%')
;


END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION SEQ_loadProbeCache(int) TO public;

COMMENT ON FUNCTION mgd.SEQ_loadProbeCache(int) IS '';

EOSQL
