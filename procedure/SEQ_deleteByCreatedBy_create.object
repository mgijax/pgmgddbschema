#!/bin/csh -f

#
# History
#
# 10/18/2011	lec
#	- TR10841/attribute/history obsolete
#
# 07/22/2004
#	- add in logic for removing Seq/Marker associatons,
#	SEQ_Coord_Cache
#
# 03/24/2004
#	- JSAM
#

cd `dirname $0` && source ./Configuration

cat - <<EOSQL | ${MGI_DBUTILS}/bin/doisql.csh ${DBSERVER} ${DBNAME} $0

use ${DBNAME}
go

create procedure SEQ_deleteByCreatedBy
  @createdBy varchar(50)
as

/*
 * Delete Sequence objects by Created By
*/

declare @userKey integer
select @userKey = _User_key from MGI_User where login = @createdBy

select _Object_key, accID, _LogicalDB_key
into #toDelete
from ACC_Accession
where _MGIType_key = 19
and _CreatedBy_key = @userKey

create clustered index idx_primary on #toDelete(_Object_key)

/* Delete Marker associations to these Sequence objects by Created By */

select a._Accession_key
into #assocToDelete
from #toDelete d, ACC_Accession a
where d.accID = a.accID
and d._LogicalDB_key = a._LogicalDB_key
and a._MGIType_key = 2
and a._CreatedBy_key = @userKey

create clustered index idx_primary on #assocToDelete(_Accession_key)

/* let's delete in steps, it'll be faster */

delete MAP_Coord_Feature
from #toDelete d, MAP_Coord_Feature s
where d._Object_key = s._Object_key
and s._MGIType_key = 19

delete SEQ_Coord_Cache 
from #toDelete d, SEQ_Coord_Cache s
where d._Object_key = s._Sequence_key

delete SEQ_Description_Cache 
from #toDelete d, SEQ_Description_Cache s
where d._Object_key = s._Sequence_key

delete SEQ_Marker_Cache 
from #toDelete d, SEQ_Marker_Cache s
where d._Object_key = s._Sequence_key

delete SEQ_Probe_Cache 
from #toDelete d, SEQ_Probe_Cache s
where d._Object_key = s._Sequence_key

delete SEQ_Source_Assoc
from #toDelete d, SEQ_Source_Assoc s
where d._Object_key = s._Sequence_key

delete MGI_Reference_Assoc
from #toDelete d, MGI_Reference_Assoc s
where d._Object_key = s._Object_key
and s._MGIType_key = 19

delete MGI_Note 
from #toDelete d, MGI_Note s
where d._Object_key = s._Object_key
and s._MGIType_key = 19

delete ACC_Accession
from #toDelete d, ACC_Accession s
where d._Object_key = s._Object_key
and s._MGIType_key = 19

delete SEQ_Sequence_Raw
from #toDelete d, SEQ_Sequence_Raw s
where d._Object_key = s._Sequence_key

delete SEQ_Sequence
from #toDelete d, SEQ_Sequence s
where d._Object_key = s._Sequence_key

delete ACC_Accession
from #assocToDelete d, ACC_Accession s
where d._Accession_key = s._Accession_key

go

quit

EOSQL
