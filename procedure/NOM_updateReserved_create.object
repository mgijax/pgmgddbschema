#!/bin/sh

#
# History
#
# 06/30/2004	lec
#	- TR 5998
#
# 06/27/2003	lec
#	TR 4929
#

cd `dirname $0` && . ./Configuration

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

DROP FUNCTION NOM_updateReserved(varchar);

CREATE OR REPLACE FUNCTION NOM_updateReserved (
v_symbol varchar(50)
)
RETURNS VOID AS
\$\$

DECLARE
nomenKey int;
approvedKey int;
reservedKey int;


BEGIN

/* If the symbol exists in Nomen as Reserved, then change its status to Approved */

approvedKey := _Term_key from VOC_Term WHERE _Vocab_key = 16 AND term = 'Approved';

reservedKey := _Term_key from VOC_Term WHERE _Vocab_key = 16 AND term = 'Reserved';

nomenKey := _Nomen_key from NOM_Marker WHERE symbol = v_symbol AND _NomenStatus_key = reservedKey;

IF nomenKey IS NOT NULL
THEN
	UPDATE NOM_Marker
	SET _NomenStatus_key = approvedKey,
	statusNote = statusNote || '; Status changed to Approved on ' ||
	current_date::char(10) || ' due to a rename in MGD.',
	modification_date = current_date
	WHERE _Nomen_key = nomenKey
	;

	RAISE notice E'The symbol %1! was a Reserved symbol in Nomen.  \nPlease check the Nomenclature Notes in Nomen for possible Sequence information.', v_symbol;
END IF;


END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION NOM_updateReserved(varchar) TO public;

COMMENT ON FUNCTION mgd.NOM_updateReserved(varchar) IS '';

EOSQL
