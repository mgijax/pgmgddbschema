#!/bin/sh

#
# History
#
# 02/16/2010	lec
#	- TR9239; rawbiotype, _BiotypeConflict_key
#	  add _Marker_Type_key
#
# 10/12/2005	lec
#	- added primary sequence accession ID to SEQ_Marker_Cache
#
# 06/28/2005	lec
#	- added provider and type to SEQ_Marker_Cache
#
# 01/12/2004
#	- JSAM
#

cd `dirname $0` && . ./Configuration

${PG_MGD_DBSCHEMADIR}/procedure/SEQ_loadMarkerCache_drop.object

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

CREATE OR REPLACE FUNCTION SEQ_loadMarkerCache (
sequenceKey int
)
RETURNS VOID AS
\$\$

DECLARE
userKey int;
nextCacheKey int;
nsqualityKey int;
nabiotypeKey int;


BEGIN

/* begin transaction */
userKey := _User_key FROM MGI_User WHERE login = current_user;

nextCacheKey := max(_Cache_key) + 1 FROM SEQ_Marker_Cache;

nsqualityKey := _Term_key FROM VOC_Term WHERE _Vocab_key = 28 AND term = 'Not Specified';

nabiotypeKey := _Term_key FROM VOC_Term WHERE _Vocab_key = 76 AND term = 'Not Applicable';

DELETE FROM SEQ_Marker_Cache WHERE _Sequence_key = sequenceKey;

INSERT INTO SEQ_Marker_Cache
SELECT DISTINCT nextCacheKey, s._Object_key, m._Object_key, mm._Organism_key, ar._Refs_key, nsqualityKey,
ss._SequenceProvider_key, ss._SequenceType_key, s._LogicalDB_key, mm._Marker_Type_key, nabiotypeKey, ac.accID, null,
m.modification_date, userKey, userKey, current_date, current_date
FROM ACC_Accession s, ACC_Accession m, ACC_AccessionReference ar, SEQ_Sequence ss, MRK_Marker mm, ACC_Accession ac
WHERE s._MGIType_key = 19
AND s.accID = m.accID
AND s._LogicalDB_key = m._LogicalDB_key
AND m._MGIType_key = 2
AND m._Accession_key = ar._Accession_key
AND s._Object_key = sequenceKey
AND s._Object_key = ss._Sequence_key
AND m._Object_key = mm._Marker_key
AND s._Object_key = ac._Object_key
AND ac._MGIType_key = 19
AND ac.preferred = 1
;

/* commit transaction */

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION SEQ_loadMarkerCache(int) TO public;

COMMENT ON FUNCTION mgd.SEQ_loadMarkerCache(int) IS '';

EOSQL
