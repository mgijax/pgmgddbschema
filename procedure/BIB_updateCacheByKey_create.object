#!/bin/sh

#
# History
#
# 08/09/2017    lec 
#       - TR12250/Lit Triage

cd `dirname $0` && . ./Configuration

${PG_MGD_DBSCHEMADIR}/procedure/BIB_updateCacheByKey_drop.object

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

CREATE OR REPLACE FUNCTION BIB_updateCacheByKey (
v_refsKey int
)
RETURNS VOID AS
\$\$

BEGIN

DELETE FROM BIB_Citation_Cache where _Refs_key = v_refsKey;

INSERT INTO BIB_Citation_Cache
SELECT r._Refs_key, null, null, a.accID, null, null, 
r.journal, 
coalesce(r.journal, '') || ' ' || coalesce(r.date, '') || ';' ||  
coalesce(r.vol, '') || '(' || coalesce(r.issue, '') || '):' ||  
coalesce(r.pgs, '') as citation, 
coalesce(r._primary, '') || ', ' || coalesce(r.journal, '') || ' ' ||  
coalesce(r.date, '') || ';' || coalesce(r.vol, '') || '(' ||  
coalesce(r.issue, '') || '):' || coalesce(r.pgs, '') as short_citation,
s.term as referenceType, 
r.isReviewArticle, 
case when isReviewArticle = 1 then 'Yes' else 'No' end,
r.isDiscard
FROM BIB_Refs r, VOC_Term s, ACC_Accession a
WHERE r._Refs_key = v_refsKey
AND r._ReferenceType_key = s._Term_key 
AND r._Refs_key = a._Object_key 
AND a._MGIType_key = 1 
AND a._LogicalDB_key = 1 
AND a.prefixPart =  'MGI:'
;

UPDATE BIB_Citation_Cache r
SET numericPart = a.numericPart, jnumID = a.accID
FROM ACC_Accession a 
WHERE r._Refs_key = v_refsKey
AND r._Refs_key = a._Object_key 
AND a._MGIType_key = 1 
AND a._LogicalDB_key = 1 
AND a.prefixPart = 'J:' 
AND a.preferred = 1 
;

UPDATE BIB_Citation_Cache r
SET pubmedID = a.accID
FROM ACC_Accession a 
WHERE r._Refs_key = v_refsKey
AND r._Refs_key = a._Object_key 
AND a._MGIType_key = 1 
AND a._LogicalDB_key = 29
AND a.preferred = 1 
;

UPDATE BIB_Citation_Cache r
SET doiID = a.accID
FROM ACC_Accession a 
WHERE r._Refs_key = v_refsKey
AND r._Refs_key = a._Object_key 
AND a._MGIType_key = 1 
AND a._LogicalDB_key = 65
AND a.preferred = 1 
;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION BIB_updateCacheByKey(int) TO public;

COMMENT ON FUNCTION mgd.BIB_updateCacheByKey(int) IS 'update BIB_Citation_Cache by specific object';

EOSQL
