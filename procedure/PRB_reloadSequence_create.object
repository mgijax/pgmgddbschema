#!/bin/sh

#
# History
#
#

cd `dirname $0` && . ./Configuration

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

DROP FUNCTION PRB_reloadSequence(int);

CREATE OR REPLACE FUNCTION PRB_reloadSequence (
probeKey int
)
RETURNS VOID AS
\$\$

DECLARE
userKey int;

BEGIN

SELECT INTO userKey _User_key FROM MGI_User WHERE login = current_user
;

DELETE FROM SEQ_Probe_Cache WHERE _Probe_key = probeKey
;

INSERT INTO SEQ_Probe_Cache
SELECT distinct s._Object_key, m._Object_key, ar._Refs_key, m.modification_date, userKey, userKey, current_date, current_date
FROM ACC_Accession s, ACC_Accession m, ACC_AccessionReference ar
WHERE s._MGIType_key = 19
AND s.accID = m.accID
AND s._LogicalDB_key = m._LogicalDB_key
AND m._MGIType_key = 3
AND m._Accession_key = ar._Accession_key
AND m._Object_key = probeKey
AND not exists (SELECT 1 FROM PRB_Notes pn
WHERE m._Object_key = pn._Probe_key
AND pn.note LIKE 'The source of the material used to create this cDNA probe was different%')
;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION PRB_reloadSequence(int) TO public;

COMMENT ON FUNCTION mgd.PRB_reloadSequence(int) IS '';

EOSQL
