#!/bin/sh

#
# History
#
# 08/18/2014	lec
#
# 05/10/2004	lec
#	- remove bad gel lanes
#

cd `dirname $0` && . ./Configuration

${PG_MGD_DBSCHEMADIR}/procedure/GXD_removeBadGelBand_drop.object

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

CREATE OR REPLACE FUNCTION GXD_removeBadGelBand (
assayKey int
)
RETURNS VOID AS
\$\$

BEGIN

select distinct _Assay_key into temporary table tmp_band from GXD_GelRow;
select tmp_band.*, b.*
from tmp_band, GXD_GelBand b, GXD_GelRow r, GXD_GelLane l
WHERE b._GelLane_key = l._GelLane_key
AND r._GelRow_key = b._GelRow_key
AND r._Assay_key != l._Assay_key
AND r._Assay_key = tmp_band._Assay_key
;

DELETE FROM GXD_GelBand
USING GXD_GelBand b, GXD_GelRow r, GXD_GelLane l
WHERE b._GelLane_key = l._GelLane_key
AND r._GelRow_key = b._GelRow_key
AND r._Assay_key != l._Assay_key
AND r._Assay_key = assayKey
;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION GXD_removeBadGelBand(int) TO public;

COMMENT ON FUNCTION mgd.GXD_removeBadGelBand(int) IS 'deletes bad gel lanes';

EOSQL
