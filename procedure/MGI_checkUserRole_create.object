#!/bin/sh

#
# History
#
# 02/23/2011	lec
#	- TR10584/add all EI modules to this list
#
# 02/17/2011	lec
#	- TR 10584/fix MPVocAnnot permissions
#
# 06/17/2005 lec
#	- TR 3557/Images
#
# 02/14/2005 lec
#	- check if User has appropriate Role based on the EI module
#

cd `dirname $0` && . ./Configuration

${PG_MGD_DBSCHEMADIR}/procedure/MGI_checkUserRole_drop.object

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

CREATE OR REPLACE FUNCTION MGI_checkUserRole (
	eiModule varchar(50),
	userLogin mgi_user.login%TYPE
)
RETURNS INTEGER AS
\$\$

DECLARE
isVerified int := 1;

BEGIN

IF eiModule = 'AlleleModule'
THEN
	IF userLogin IN
	(SELECT login FROM MGI_UserRole_View
		WHERE userrole IN ('Pheno:Tier 4 (curator)',
			'Pheno:Tier 5 (guru)'))
	THEN
		isVerified := 1;

	ELSE
		isVerified := 0;

	END IF;

ELSIF eiModule = 'ImageModule'
THEN
	IF userLogin IN
	(SELECT login FROM MGI_UserRole_View
		WHERE userrole IN ('GXD ImageModule',
			'Pheno:Tier 4 (curator)',
			'Pheno:Tier 5 (guru)'))
	THEN
		isVerified := 1;

	ELSE
		isVerified := 0;

	END IF;

ELSIF eiModule IN ('AlleleDerivationModule',
		'AntibodyModule',
		'AntigenModule',
		'AssayModule',
		'ControlledVocabModule',
		'CrossModule',
		'DictionaryModule',
		'GenotypeModule',
		'MappingModule',
		'MarkerModule',
		'MarkerNonMouseModule',
		'MolecularSegmentModule',
		'MolecularSourceModule',
		'MPVocAnnot',
		'NomenModule',
		'GOVocAnnot',
		'IndexStageModule',
		'OMIMVocAnnot',
		'OrganismModule',
		'OrthologyModule',
		'RISetModule',
		'SequenceModule',
		'SimpleVocabModule',
		'StrainModule',
		'StrainJAXModule',
		'TDCVocAnnot',
		'TissueModule',
		'TranslationModule',
		'UserRoleModule')
THEN
	IF userLogin IN
		(SELECT login FROM MGI_UserRole_View WHERE userrole in (eiModule))
	THEN
		isVerified := 1;

	ELSE
		isVerified := 0;

	END IF;

-- default is to give permissions if none have been given
ELSE
	isVerified := 1;

END IF;

RETURN isVerified;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION MGI_checkUserRole(varchar,varchar) TO public;

COMMENT ON FUNCTION mgd.MGI_checkUserRole(varchar,varchar) IS 'check if User has appropriate Role based on the EI module';

EOSQL
