#!/bin/sh

#
# History
#
# 08/25/2014    lec
#       - TR11654/stored procedures for postgres
# 03/29/2012	lec
#	- TR 11025/default...copyright equals note
#
# 05/15/2008	lec
#	- TR 8962; add J Biol Chem, J Lipid Res
#
# 02/09/2007	lec
#	- TR 8147; added PNAS
#	- moved substitution logic out of EI into here
#
# 02/01/2007	lec
#	- TR 8138
#

cd `dirname $0` && . ./Configuration

${PG_MGD_DBSCHEMADIR}/procedure/BIB_getCopyright_drop.object

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

CREATE OR REPLACE FUNCTION BIB_getCopyright (
v_refsKey int,
out copyright varchar(255)
)
AS
\$\$

DECLARE
v_note varchar(255);
v_short_citation varchar(255);
v_journal varchar(255);
v_jnumID varchar(30);
v_pubmedID varchar(30);
v_year char(4);
s1 varchar(255);
s2 varchar(255);
s  varchar(255);
idx int;

BEGIN

/* Returns copyright for journal */
SELECT
c.note,
r.short_citation,
r.journal,
r.jnumID,
r.year::char(4),
cc.pubmedID
INTO
v_note,
v_short_citation,
v_journal,
v_jnumID,
v_year,
v_pubmedID
FROM BIB_View r, BIB_Citation_Cache cc, VOC_Term t, MGI_Note n, MGI_NoteChunk c
WHERE r._Refs_key = v_refsKey
AND r._Refs_key = cc._Refs_key
AND r.journal = t.term
AND t._Term_key = n._Object_key
AND n._MGIType_key = 13
AND n._NoteType_key = 1026
AND n._Note_key = c._Note_key
;

/* default...copyright equals note */
copyright := v_note;

IF (v_journal = 'Proc Natl Acad Sci U S A')
THEN
	idx := position('*' in v_note);

	s1 := substring(v_note, 1, idx - 1);

	s := substring(v_note, idx + 1, char_length(v_note));

	idx := position('*' in s);

	s2 := substring(s, 1, idx - 1);

	s := substring(s, idx + 1, char_length(s));

	copyright := s1 || v_short_citation || s2 || v_year || s;

	RETURN;
END IF;

idx := position('Elsevier(' in v_note);

IF (idx > 0)
THEN
	s1 := substring(v_note, 1, idx + 8);

	s2 := substring(v_note, idx + 9, char_length(v_note));

	v_note := s1 || v_jnumID || s2;

	copyright := v_note;

	RETURN;
END IF;

idx := position('JBiolChem(' in v_note);

IF (idx > 0)
THEN
	s1 := substring(v_note, 1, idx + 9);

	s2 := substring(v_note, idx + 11, char_length(v_note));

	v_note := s1 || v_pubmedID || '|JBC' || s2;

	copyright := v_note;

	RETURN;
END IF;

idx := position('JLipidRes(' in v_note);

IF (idx > 0)
THEN
	s1 := substring(v_note, 1, idx + 9);

	s2 := substring(v_note, idx + 11, char_length(v_note));

	v_note := s1 || v_pubmedID || '|JLR' || s2;

	copyright := v_note
	;

	RETURN;
END IF;

idx := position('*' in v_note);

IF (idx > 0)
THEN
	s1 := substring(v_note, 1, idx - 1);

	s2 := substring(v_note, idx + 1, char_length(v_note));

	v_note := s1 || v_short_citation || s2;

	copyright := v_note;

	RETURN;
END IF;


END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION BIB_getCopyright(int) TO public;

COMMENT ON FUNCTION mgd.BIB_getCopyright(int) IS '';

EOSQL
