#!/bin/sh

#
# History
#
# 07/22/2003	lec
#	- TR 3404/JSAM
#

cd `dirname $0` && . ./Configuration

${PG_MGD_DBSCHEMADIR}/procedure/PRB_processAntigenAnonSource_drop.object

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

CREATE OR REPLACE FUNCTION PRB_processAntigenAnonSource (
v_objectKey int,
v_msoKey int,
v_organismKey int,
v_strainKey int,
v_tissueKey int,
v_genderKey int,
v_cellLineKey int,
v_age prb_source.age%TYPE,
v_tissueTreatment prb_source.description%TYPE,
v_modifiedByKey int
)
RETURNS VOID AS
\$\$

DECLARE
v_segmentTypeKey int;
v_vectorTypeKey int;
v_newMSOKey int;

BEGIN

-- process (modify) a Antigen's Anonymous Molecular Source                  */

v_segmentTypeKey :=  _Term_key from VOC_Term where _Vocab_key = 10 and term = 'Not Specified';

v_vectorTypeKey := _Term_key from VOC_Term where _Vocab_key = 24 and term = 'Not Specified' ;

SELECT * INTO v_newMSOKey 
FROM PRB_processAnonymousSource(v_msoKey, v_segmentTypeKey, v_vectorTypeKey, v_organismKey, v_strainKey,
    		v_tissueKey, v_genderKey, v_cellLineKey, v_age, v_tissueTreatment, v_modifiedByKey, 0);

IF NOT FOUND
THEN
        RAISE EXCEPTION E'PRB_processAntigenAnonSource : perform PRB_processAnonymousSource failed.';
        RETURN;
END IF;

-- associate the Antigen with the MSO */
-- _ModifiedBy_key = modifiedByKey, */

UPDATE GXD_Antigen
SET _Source_key = v_newMSOKey,
modification_date = current_date
WHERE _Antigen_key = v_objectKey
;

-- delete the input @msoKey if it's now an orphan */

IF NOT EXISTS (select 1 from SEQ_Source_Assoc where _Source_key = v_msoKey) and
	NOT EXISTS (select 1 from PRB_Probe where _Source_key = v_msoKey) and
	NOT EXISTS (select 1 from GXD_Antigen where _Source_key = v_msoKey)
THEN
	DELETE from PRB_Source where _Source_key = v_msoKey;
END IF;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION PRB_processAntigenAnonSource(int,int,int,int,int,int,int,varchar,text,int) TO public;

COMMENT ON FUNCTION PRB_processAntigenAnonSource(int,int,int,int,int,int,int,varchar,text,int) IS 'process (modify) a Antigen''s Anonymous Molecular Source';

EOSQL
