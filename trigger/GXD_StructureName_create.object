#!/bin/sh

cd `dirname $0` && . ./Configuration

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

--
-- NAME: GXD_StructureName_insert()
--
-- DESCRIPTOIN:
--
-- 1) Inserted StructureName specifies a non-existent Structure
-- 2) Inserted StructureName has duplicate structure attribute
-- 3) Parent node cannot have two children with the same preferred name
--
-- INPUT:
--	none
--
-- RETURNS:
--	NEW
--

DROP TRIGGER IF EXISTS GXD_StructureName_insert_trigger ON GXD_StructureName;
DROP FUNCTION IF EXISTS GXD_StructureName_insert();

CREATE OR REPLACE FUNCTION GXD_StructureName_insert() RETURNS TRIGGER AS \$\$
BEGIN

-- ensure that the structure specified exists

IF NOT EXISTS (SELECT * FROM GXD_Structure s
              WHERE s._Structure_key = NEW._Structure_key)
THEN
    RAISE EXCEPTION E'GXD_StructureName: Inserted StructureName specifies a non-existent Structure';
END IF;

-- look for duplicate (structure key, structure) tuples

IF (SELECT count(*) 
   FROM GXD_StructureName sn
   WHERE sn._Structure_key = NEW._Structure_key
   AND sn.structure = NEW.structure) >  1
THEN
    RAISE EXCEPTION E'GXD_StructureName: Inserted StructureName has duplicate structure attribute';
END IF;

-- Prevent two children from having the same preferred name

IF (SELECT count(*)
    FROM GXD_Structure s1, GXD_Structure s2, GXD_StructureName sn2
    WHERE s1._Parent_key = s2._Parent_key
    AND sn2._StructureName_key = s2._StructureName_key
    AND NEW._StructureName_key = s1._StructureName_key 
    AND NEW.structure = sn2.structure) > 1
THEN
    RAISE EXCEPTION E'GXD_StructureName: Parent node cannot have two children with the same preferred name';
END IF;

RETURN NEW;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION GXD_StructureName_insert() TO public;

CREATE TRIGGER GXD_StructureName_insert_trigger
AFTER INSERT ON GXD_StructureName
FOR EACH ROW
EXECUTE PROCEDURE GXD_StructureName_insert();

COMMENT ON FUNCTION mgd.GXD_StructureName_insert() IS 'creates an insert trigger to call acc_assignmgi()/default values';

EOSQL

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

--
-- NAME: GXD_StructureName_update()
--
-- DESCRIPTOIN:
--
-- 1) Inserted StructureName has duplicate structure attribute
--
-- INPUT:
--	none
--
-- RETURNS:
--	NEW
--

DROP TRIGGER IF EXISTS GXD_StructureName_update_trigger ON GXD_StructureName;
DROP FUNCTION IF EXISTS GXD_StructureName_update();

CREATE OR REPLACE FUNCTION GXD_StructureName_update() RETURNS TRIGGER AS \$\$
BEGIN

IF (SELECT count(*) FROM GXD_StructureName sn
    WHERE sn._Structure_key = NEW._Structure_key
    AND sn.structure = NEW.structure) >
   (SELECT count(*) from NEW)
THEN
    RAISE EXCEPTION E'GXD_StructureName: Inserted StructureName has duplicate structure attribute';
END IF;

RETURN NEW;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION GXD_StructureName_update() TO public;

CREATE TRIGGER GXD_StructureName_update_trigger
AFTER UPDATE ON GXD_StructureName
FOR EACH ROW
EXECUTE PROCEDURE GXD_StructureName_update();

COMMENT ON FUNCTION mgd.GXD_StructureName_update() IS 'creates an insert trigger to call acc_assignmgi()/default values';

EOSQL
