#!/bin/sh

cd `dirname $0` && . ./Configuration

cat - <<EOSQL | ${PG_DBUTILS}/bin/doisql.csh $0

DROP TRIGGER IF EXISTS MGI_Note_insert_trigger ON MGI_Note;
DROP FUNCTION IF EXISTS MGI_Note_insert();

CREATE OR REPLACE FUNCTION MGI_Note_insert() RETURNS TRIGGER AS \$\$
BEGIN

--
-- NAME: MGI_Note_insert()
--
-- DESCRIPTOIN:
--
--	if the MGI_Note row already exists for:
--              (_object_key, _mgitype_key, _notetype_key)
--      return null; do not insert the row
--
-- INPUT:
--	none
--
-- RETURNS:
--	NEW
--

-- at most one note per _object_key, _mgitype_key, _notetype_key
IF (SELECT count(*) FROM MGI_Note 
        WHERE _object_key = NEW._object_key 
        AND _mgitype_key = NEW._mgitype_key 
        AND _notetype_key = NEW._notetype_key) = 1
THEN
    RETURN NULL;
END IF;

RETURN NEW;

END;
\$\$
LANGUAGE plpgsql;

GRANT EXECUTE ON FUNCTION MGI_Note_insert() TO public;

CREATE TRIGGER MGI_Note_insert_trigger
BEFORE INSERT ON MGI_Note
FOR EACH ROW
EXECUTE PROCEDURE MGI_Note_insert();

COMMENT ON FUNCTION mgd.MGI_Note_insert() IS 'creates an insert trigger to add at most one note per _object_key, _mgitype_key, _notetype_key';

EOSQL
