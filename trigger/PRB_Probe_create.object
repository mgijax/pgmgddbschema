#!/bin/csh -f

#
# History
#
# 12/10/2002	lec
#	- TR 3928; update trigger; return if rowcount > 1
#
# 12/09/2002	lec
#	- TR 3928; prevent deletion of RIKEN (Fantom2) segments
#
# 10/24/2002	lec
#	- removed reference to user 'rpp'
#
# 05/13/2002	lec
#	- TR 1463; SAO
#

cd `dirname $0` && source ./Configuration

cat - <<EOSQL | ${MGI_DBUTILS}/bin/doisql.csh ${DBSERVER} ${DBNAME} $0

use ${DBNAME}
go

create trigger PRB_Probe_Insert
on PRB_Probe
for insert
as
 
/* Assign MGI Accession number for each Molecular Segment */

declare @key integer
select @key = _Probe_key from inserted
exec ACC_assignMGI @key, "Segment"

if (@@error != 0)
begin
  rollback transaction
  return
end
 

go

create trigger PRB_Probe_Update
on PRB_Probe
for update
as
 
if @@rowcount > 1
	return

if update (_Source_key)
begin
	/* Delete orphan Anonymous _Source_keys */

	if (select PRB_Source.name from PRB_Source, deleted
	    where PRB_Source._Source_key = deleted._Source_key) is null
	    and
	   not exists (select * from PRB_Probe, deleted
            where PRB_Probe._Source_key = deleted._Source_key)
	begin
		delete PRB_Source from PRB_Source, deleted
		where PRB_Source._Source_key = deleted._Source_key
	end

	/* Update _Source_key for all children of Parent */

	update PRB_Probe set _Source_key = inserted._Source_key
	from PRB_Probe, inserted
	where PRB_Probe.derivedFrom = inserted._Probe_key
end

go

create trigger PRB_Probe_Delete
on PRB_Probe
for delete
as

/* Disallow deletion if Molecular Segment is referenced elsewhere */

if exists (select * from PRB_Probe, deleted
    where PRB_Probe.derivedFrom = deleted._Probe_key)
begin
        rollback transaction
        raiserror 99999 "Molecular Segment is referenced as a Parent in Molecular Segment record(s)"
	return
end
 
if exists (select * from MLD_Hit, deleted
         where MLD_Hit._Probe_key = deleted._Probe_key)
begin
        rollback transaction
        raiserror 99999 "Molecular Segment is referenced in MLDP Hit record(s)"
	return
end
 
if exists (select * from MLD_Hit, deleted
         where MLD_Hit._Target_key = deleted._Probe_key)
begin
        rollback transaction
        raiserror 99999 "Molecular Segment is referenced as a Target in MLDP Hit record(s)"
	return
end
 
if exists (select * from MLD_ContigProbe, deleted
         where MLD_ContigProbe._Probe_key = deleted._Probe_key)
begin
        rollback transaction
        raiserror 99999 "Molecular Segment is referenced in MLDP Contig/Probe record(s)"
	return
end
 
if exists (select * from GXD_ProbePrep, deleted
         where GXD_ProbePrep._Probe_key = deleted._Probe_key)
begin
        rollback transaction
        raiserror 99999 "Molecular Segment is referenced in GXD Probe Prep record(s)"
	return
end

/* Disallow edits to WashU data - TR 611 */

if exists (select * from PRB_Reference_View r, deleted d
	where r._Probe_key = d._Probe_key and
	      r.jnum = 57656)
   and
   (select user_name()) not in ('mgd_dbo', 'dbo')
begin
        rollback transaction
        raiserror 99999 "Molecular Segment is referenced by J:57656, WashU-HHMI Database Download.  Cannot delete record."
	return
end

delete PRB_Marker from PRB_Marker p, deleted d
where p._Probe_key = d._Probe_key

delete PRB_Notes from PRB_Notes p, deleted d
where p._Probe_key = d._Probe_key

delete PRB_Reference from PRB_Reference p, deleted d
where p._Probe_key = d._Probe_key

delete SEQ_Probe_Cache from SEQ_Probe_Cache p, deleted d
where p._Probe_key = d._Probe_key

delete ACC_AccessionReference 
from ACC_Accession a, ACC_AccessionReference ar, deleted d
where a._Object_key = d._Probe_key
and a._MGIType_key = 3
and a._Accession_key = ar._Accession_key
 
delete ACC_Accession 
from ACC_Accession a, deleted d
where a._Object_key = d._Probe_key
and a._MGIType_key = 3
 

go

checkpoint
go

quit

EOSQL
