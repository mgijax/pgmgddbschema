#!/bin/csh -f -x

#
# History
#
# 09/16/2010    lec
#       - TR9695/eurexpress/only call priority update 
#         if less than 500 index for given reference
#
# 09/28/2006	lec
#	- TR 7918; add BIB_DataSet_Assoc insert
#
# 05/13/2002	lec
#	- TR 1463; SAO
#

cd `dirname $0` && source ./Configuration

cat - <<EOSQL | ${MGI_DBUTILS}/bin/doisql.csh ${DBSERVER} ${DBNAME} $0

use ${DBNAME}
go

create trigger GXD_Index_Insert
on GXD_Index
for insert
as

-- This trigger only works with single row insertions.  Bail out if multiple.

if @@rowcount > 1
	return

-- Skip this update if there is > 500 indexes for this reference

if (select count(*) from GXD_Index g, inserted i 
    where i._Refs_key = g._Refs_key) <= 500
begin
  update GXD_Index
  set _Priority_key = i._Priority_key, 
      _ConditionalMutants_key = i._ConditionalMutants_key
  from GXD_Index g, inserted i
  where i._Refs_key = g._Refs_key
end

if not exists (select 1 from inserted i, BIB_DataSet_Assoc b
	where i._Refs_key = b._Refs_key
	and b._DataSet_key = 1004)
begin
    declare @assocKey integer
    select @assocKey = max(_Assoc_key) + 1 from BIB_DataSet_Assoc
    insert into BIB_DataSet_Assoc
    	select @assocKey, i._Refs_key, 1004, 0, i._CreatedBy_key, i._ModifiedBy_key, getdate(), getdate() from inserted i
end

go

create trigger GXD_Index_Update
on GXD_Index
for update
as

-- This trigger only works for single-row updates; bail out if multiples.

if @@rowcount > 1
	return

if update(_Priority_key) or update(_ConditionalMutants_key)
begin
	update GXD_Index
	set _Priority_key = i._Priority_key, _ConditionalMutants_key = i._ConditionalMutants_key
	from GXD_Index g, inserted i
	where i._Refs_key = g._Refs_key
end

go

checkpoint
go

quit

EOSQL
