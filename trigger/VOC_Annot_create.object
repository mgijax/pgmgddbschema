#!/bin/csh -f -x

#
# History
#
# 02/23/2011	lec
# 02/15/2011	lec
#	- TR10584/strain/undo
#

cd `dirname $0` && source ./Configuration

cat - <<EOSQL | ${MGI_DBUTILS}/bin/doisql.csh ${DBSERVER} ${DBNAME} $0

use ${DBNAME}
go

create trigger VOC_Annot_Insert
on VOC_Annot
for insert
as

/* Ignore multi-row data */

if @@rowcount > 1
begin
	return
end

if (select t.isObsolete from VOC_Term t, inserted i where t._Term_key = i._Term_key) = 1
begin
	raiserror 99999 "Cannot Annotate to an Obsolete Term."
	rollback transaction
	return
end

go

create trigger VOC_Annot_Update
on VOC_Annot
for update
as

/* Ignore multi-row data */

if @@rowcount > 1
begin
	return
end

/* propagate modification date and modified by to all evidence records */
/* when the annotation term is modified. (TR 5721) */

if update(_Term_key)
begin
	declare @userKey integer
	select @userKey = _User_key from MGI_User where login = user_name()

	update VOC_Evidence
	set modification_date = getdate(), _ModifiedBy_key = @userKey
	from inserted i, VOC_Evidence e
	where i._Annot_key = e._Annot_key
end

go

checkpoint
go

quit

EOSQL
