#!/bin/csh -f -x

#
# History
#
# 08/31/2005	lec
#	- TR 6631; backed out
#
# 06/28/2005	lec
#	- put reference trigger back in
#
# 08/15/2002	lec
#	- added GXD_AlleleGenotype to delete trigger
#

cd `dirname $0` && source ./Configuration

cat - <<EOSQL | ${MGI_DBUTILS}/bin/doisql.csh ${DBSERVER} ${DBNAME} $0

use ${DBNAME}
go

create trigger GXD_Genotype_Insert
on GXD_Genotype
for insert
as
 
/* Assign MGI Accession number for each Genotype */

declare @key integer
select @key = _Genotype_key from inserted
exec ACC_assignMGI @key, "Genotype", @private = 1

if (@@error != 0)
begin
  rollback transaction
  return
end
 

go

create trigger GXD_Genotype_Delete
on GXD_Genotype
for delete
as

/* Disallow deletion if record is referenced elsewhere */

if exists (select 1 from GXD_GelLane, deleted
    where GXD_GelLane._Genotype_key = deleted._Genotype_key)
begin
        rollback transaction
        raiserror 99999 "Cannot Delete - Genotype is referenced in Gel Lane Record(s)"
	return
end

if exists (select 1 from GXD_Specimen, deleted
    where GXD_Specimen._Genotype_key = deleted._Genotype_key)
begin
        rollback transaction
        raiserror 99999 "Cannot Delete - Genotype is referenced in Specimen Record(s)"
	return
end

if exists (select 1 from GXD_Expression, deleted
    where GXD_Expression._Genotype_key = deleted._Genotype_key)
begin
        rollback transaction
        raiserror 99999 "Cannot Delete - Genotype is referenced in Expression Results (cache) Record(s)"
	return
end

if exists (select 1 from PRB_Strain_Genotype, deleted
    where PRB_Strain_Genotype._Genotype_key = deleted._Genotype_key)
begin
        rollback transaction
        raiserror 99999 "Cannot Delete - Genotype is referenced in Strain Record(s)"
        return
end

if exists (select 1 from VOC_Annot a, VOC_AnnotType t, deleted d
    where d._Genotype_key = a._Object_key
    and a._AnnotType_key = t._AnnotType_key
    and t._MGIType_key = 12)
begin
        rollback transaction
        raiserror 99999 "Cannot Delete - Genotype is referenced in Annotation Record(s)"
	return
end

delete GXD_AlleleGenotype from GXD_AlleleGenotype, deleted
where GXD_AlleleGenotype._Genotype_key = deleted._Genotype_key
 
delete GXD_AllelePair from GXD_AllelePair, deleted
where GXD_AllelePair._Genotype_key = deleted._Genotype_key
 
delete MGI_Note from MGI_Note, deleted
where MGI_Note._MGIType_key = 12
and MGI_Note._Object_key = deleted._Genotype_key

delete MRK_OMIM_Cache from MRK_OMIM_Cache, deleted
where MRK_OMIM_Cache._Genotype_key = deleted._Genotype_key
 
delete IMG_ImagePane_Assoc from IMG_ImagePane_Assoc, deleted
where IMG_ImagePane_Assoc._MGIType_key = 12
and IMG_ImagePane_Assoc._Object_key = deleted._Genotype_key

delete ACC_Accession 
from ACC_Accession a, deleted
where a._Object_key = deleted._Genotype_key
and a._MGIType_key = 12
 
go

checkpoint
go

quit

EOSQL
